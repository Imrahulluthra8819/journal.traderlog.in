<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal - Professional Trading Tracker</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Add Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;color:white;font-size:1.5rem;">
        Loading your trading journal...
    </div>
// Add this near your authentication check code
setTimeout(() => {
  if (stillLoading) {
    setLoading(false); // Force hide the loading screen
    showLoginForm(); // Show the login form instead
  }
}, 3000); // 3 seconds timeout
    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-screen">
        <div class="auth-container">
            <div class="auth-header">
                <h1>üìä Trading Journal</h1>
                <p>Professional Trading Tracker & Analytics</p>
            </div>
            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login">Login</button>
                <button class="auth-tab" data-tab="signup">Sign Up</button>
            </div>
            <!-- Login Form -->
            <div id="loginForm" class="auth-form active">
                <h2>Welcome Back</h2>
                <form id="loginFormElement" novalidate>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" name="username" class="form-control" required placeholder="Enter your email">
                        <div class="form-error" id="login-username-error"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" name="password" class="form-control" required placeholder="Enter password">
                        <div class="form-error" id="login-password-error"></div>
                    </div>
                    <button type="submit" class="btn btn--primary btn--full-width">Login</button>
                </form>
                <div class="auth-footer">
                    <a href="#" id="forgotPassword">Forgot password?</a>
                </div>
            </div>
            <!-- Signup Form -->
            <div id="signupForm" class="auth-form">
                <h2>Create Account</h2>
                <form id="signupFormElement" novalidate>
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" name="username" class="form-control" required placeholder="Choose a username" minlength="3">
                        <div class="form-error" id="signup-username-error"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-control" required placeholder="Enter your email">
                        <div class="form-error" id="signup-email-error"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" name="password" class="form-control" required placeholder="Create a password" minlength="8">
                        <div class="form-error" id="signup-password-error"></div>
                        <small class="form-help">Minimum 8 characters</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password</label>
                        <input type="password" name="confirmPassword" class="form-control" required placeholder="Confirm your password">
                        <div class="form-error" id="signup-confirmPassword-error"></div>
                    </div>
                    <button type="submit" class="btn btn--primary btn--full-width">Create Account</button>
                </form>
            </div>
            <!-- Password Reset Form -->
            <div id="passwordResetForm" class="auth-form" style="display:none;">
                <h2>Reset Password</h2>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="resetEmail" class="form-control" required placeholder="Enter your email">
                    <div id="reset-email-error" class="form-error"></div>
                </div>
                <button id="resetPasswordBtn" class="btn btn--primary btn--full-width">Send Reset Link</button>
                <div class="auth-footer">
                    <a href="#" id="backToLogin">Back to login</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app hidden">
        <!-- Navigation Bar -->
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-brand">
                    <h2>üìä Trading Journal</h2>
                </div>
                <ul class="nav-menu">
                    <li class="nav-item"><button class="nav-link active" data-section="dashboard">Dashboard</button></li>
                    <li class="nav-item"><button class="nav-link" data-section="add-trade">Add Trade</button></li>
                    <li class="nav-item"><button class="nav-link" data-section="history">Trade History</button></li>
                    <li class="nav-item"><button class="nav-link" data-section="analytics">Analytics</button></li>
                    <li class="nav-item"><button class="nav-link" data-section="ai-suggestions">AI Suggestions</button></li>
                    <li class="nav-item"><button class="nav-link" data-section="reports">Reports</button></li>
                </ul>
                <div class="nav-user">
                    <div class="user-info">
                        <span class="user-name" id="currentUserName">User</span>
                        <button class="theme-toggle" id="themeToggle">üåô</button>
                        <button class="btn btn--outline btn--sm" id="logoutBtn">Logout</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active">
                <div class="container">
                    <div class="section-header">
                        <h1>Trading Dashboard</h1>
                        <button class="btn btn--primary" id="quickAddTrade">+ Add New Trade</button>
                    </div>
                    <!-- Key Performance Metrics -->
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-icon">üí∞</div><div class="stat-content"><h3 id="totalPL" class="stat-value">‚Çπ0</h3><p>Total P&L</p></div></div>
                        <div class="stat-card"><div class="stat-icon">üìà</div><div class="stat-content"><h3 id="winRate" class="stat-value">0%</h3><p>Win Rate</p></div></div>
                        <div class="stat-card"><div class="stat-icon">üéØ</div><div class="stat-content"><h3 id="totalTrades" class="stat-value">0</h3><p>Total Trades</p></div></div>
                        <div class="stat-card"><div class="stat-icon">‚öñÔ∏è</div><div class="stat-content"><h3 id="avgRR" class="stat-value">1:0</h3><p>Avg Risk:Reward</p></div></div>
                    </div>
                    <!-- Daily Confidence Tracker -->
                    <div class="confidence-tracker card">
                        <div class="card__body">
                            <h3>How are you feeling about trading today?</h3>
                            <div class="confidence-controls">
                                <div class="confidence-slider-container">
                                    <label for="dailyConfidence" class="form-label">Confidence Level (1-10)</label>
                                    <input type="range" id="dailyConfidence" class="range-input" min="1" max="10" value="5">
                                    <div class="range-value" id="confidenceValue">5</div>
                                </div>
                                <button class="btn btn--primary" id="saveConfidenceBtn">Submit</button>
                            </div>
                            <div id="confidenceMessage" class="confidence-message"></div>
                        </div>
                    </div>
                    <!-- Recent Trades Overview -->
                    <div class="recent-trades card">
                        <div class="card__header"><h3>Recent Trades</h3><button class="view-all-link" data-section="history">View All Trades</button></div>
                        <div class="card__body"><div id="recentTradesList"><div class="loading">Loading recent trades...</div></div></div>
                    </div>
                </div>
            </section>

            <!-- Add Trade Section -->
            <section id="add-trade" class="section">
                <div class="container">
                    <div class="section-header"><h1>Add New Trade</h1><p>Record all details of your trade for complete analysis</p></div>
                    <div class="add-trade-container">
                        <div class="card add-trade-card">
                            <div class="card__header"><h3>Trade Information</h3></div>
                            <div class="card__body">
                                <form id="addTradeForm" novalidate>
                                    <!-- Basic Trade Details -->
                                    <div class="form-grid">
                                        <div class="form-group"><label class="form-label">Symbol *</label><input type="text" name="symbol" class="form-control" required placeholder="e.g., NIFTY, BANKNIFTY"><div class="form-error" id="symbol-error"></div></div>
                                        <div class="form-group"><label class="form-label">Direction *</label><select name="direction" class="form-control" required><option value="">Select Direction</option><option value="Long">Long</option><option value="Short">Short</option></select><div class="form-error" id="direction-error"></div></div>
                                        <div class="form-group"><label class="form-label">Quantity *</label><input type="number" name="quantity" class="form-control" required placeholder="Number of shares/lots" min="1"><div class="form-error" id="quantity-error"></div></div>
                                        <div class="form-group"><label class="form-label">Entry Price *</label><input type="number" name="entryPrice" class="form-control" required placeholder="Entry price" step="0.01" min="0"><div class="form-error" id="entryPrice-error"></div></div>
                                        <div class="form-group"><label class="form-label">Exit Price *</label><input type="number" name="exitPrice" class="form-control" required placeholder="Exit price" step="0.01" min="0"><div class="form-error" id="exitPrice-error"></div></div>
                                        <div class="form-group"><label class="form-label">Stop Loss</label><input type="number" name="stopLoss" class="form-control" placeholder="Stop loss price" step="0.01" min="0"></div>
                                        <div class="form-group"><label class="form-label">Target Price</label><input type="number" name="targetPrice" class="form-control" placeholder="Target price" step="0.01" min="0"></div>
                                        <div class="form-group"><label class="form-label">Strategy</label><select name="strategy" class="form-control"><option value="">Select Strategy</option><option value="Breakout + VWAP">Breakout + VWAP</option><option value="Support Resistance">Support Resistance</option><option value="Trendline Bounce">Trendline Bounce</option><option value="Breakout Failure">Breakout Failure</option><option value="Scalping">Scalping</option><option value="Swing Trading">Swing Trading</option><option value="Other">Other</option></select></div>
                                        <div class="form-group"><label class="form-label">Exit Reason</label><select name="exitReason" class="form-control"><option value="">Select Exit Reason</option><option value="Target Hit">Target Hit</option><option value="SL Hit">Stop Loss Hit</option><option value="Manual Exit">Manual Exit</option><option value="Time Based Exit">Time Based Exit</option><option value="Breakeven">Breakeven</option><option value="Trailing Stop">Trailing Stop</option></select></div>
                                        <div class="form-group"><label class="form-label">Confidence Level (1-10)</label><input type="range" name="confidenceLevel" class="range-input" min="1" max="10" value="5"><div class="range-value">5</div></div>
                                        <div class="form-group"><label class="form-label">Entry Date *</label><input type="datetime-local" name="entryDate" class="form-control" required><div class="form-error" id="entryDate-error"></div></div>
                                        <div class="form-group"><label class="form-label">Exit Date *</label><input type="datetime-local" name="exitDate" class="form-control" required><div class="form-error" id="exitDate-error"></div></div>
                                        <div class="form-group"><label class="form-label">Pre-Trade Emotion</label><select name="preEmotion" class="form-control"><option value="">Select Emotion</option><option value="Confident">Confident</option><option value="Excited">Excited</option><option value="Nervous">Nervous</option><option value="Fearful">Fearful</option><option value="Neutral">Neutral</option><option value="Greedy">Greedy</option><option value="Impatient">Impatient</option></select></div>
                                        <div class="form-group"><label class="form-label">Post-Trade Emotion</label><select name="postEmotion" class="form-control"><option value="">Select Emotion</option><option value="Satisfied">Satisfied</option><option value="Relieved">Relieved</option><option value="Disappointed">Disappointed</option><option value="Frustrated">Frustrated</option><option value="Regretful">Regretful</option><option value="Elated">Elated</option><option value="Neutral">Neutral</option></select></div>
                                        <div class="form-group full-width"><label class="form-label">Notes</label><textarea name="notes" class="form-control" rows="3" placeholder="What went well, what went wrong, improvements needed..."></textarea></div>
                                    </div>

                                    <!-- ====================== New Psychology-Focused Sections ====================== -->
                                    <!-- Pre-Trade Psychology -->
                                    <details class="collapse-card">
                                        <summary>Pre-Trade Psychology</summary>
                                        <div class="collapse-content">
                                            <div class="form-grid">
                                                <div class="form-group"><label class="form-label" title="How well did you sleep last night?">Sleep Quality (1-10)</label><input type="range" name="sleepQuality" class="range-input" min="1" max="10" value="5"><div class="range-value">5</div></div>
                                                <div class="form-group"><label class="form-label" title="How is your physical energy today?">Physical Condition (1-10)</label><input type="range" name="physicalCondition" class="range-input" min="1" max="10" value="5"><div class="range-value">5</div></div>
                                                <div class="form-group"><label class="form-label">Market Sentiment Assessment</label><select name="marketSentiment" class="form-control"><option value="">Select</option><option>Bullish</option><option>Bearish</option><option>Neutral</option><option>Uncertain</option></select></div>
                                                <div class="form-group"><label class="form-label">News / Events Awareness</label><select name="newsAwareness" class="form-control"><option value="">Select</option><option>Major news expected</option><option>Minor news</option><option>No significant news</option><option>Unaware</option></select></div>
                                                <div class="form-group"><label class="form-label">Overall Market Environment</label><select name="marketEnvironment" class="form-control"><option value="">Select</option><option>Strong Trend Up</option><option>Weak Trend Up</option><option>Sideways / Range</option><option>Weak Trend Down</option><option>Strong Trend Down</option></select></div>
                                                <div class="form-group"><label class="form-label" title="Are you feeling Fear of Missing Out on this trade?">FOMO Level (1-10)</label><input type="range" name="fomoLevel" class="range-input" min="1" max="10" value="1"><div class="range-value">1</div></div>
                                                <div class="form-group"><label class="form-label">Stress Level Before Trade (1-10)</label><input type="range" name="preStress" class="range-input" min="1" max="10" value="1"><div class="range-value">1</div></div>
                                            </div>
                                        </div>
                                    </details>

                                    <!-- Trade Setup Analysis -->
                                    <details class="collapse-card">
                                        <summary>Trade Setup Analysis</summary>
                                        <div class="collapse-content">
                                            <div class="form-grid">
                                                <div class="form-group full-width"><label class="form-label">Multiple Time-Frame Confirmation</label>
                                                    <div class="checkbox-group">
                                                        <label><input type="checkbox" name="multiTimeframes" value="Daily aligned"> Daily aligned</label><br>
                                                        <label><input type="checkbox" name="multiTimeframes" value="4H aligned"> 4H aligned</label><br>
                                                        <label><input type="checkbox" name="multiTimeframes" value="1H aligned"> 1H aligned</label><br>
                                                        <label><input type="checkbox" name="multiTimeframes" value="15min aligned"> 15min aligned</label>
                                                    </div>
                                                </div>
                                                <div class="form-group"><label class="form-label">Volume Analysis</label><select name="volumeAnalysis" class="form-control"><option value="">Select</option><option>High volume</option><option>Average volume</option><option>Low volume</option><option>Volume spike</option><option>Volume dry-up</option></select></div>
                                                <div class="form-group full-width"><label class="form-label">Technical Confluence Factors</label>
                                                    <div class="checkbox-group">
                                                        <label><input type="checkbox" name="technicalConfluence" value="Support / Resistance"> Support / Resistance</label><br>
                                                        <label><input type="checkbox" name="technicalConfluence" value="Moving Average"> Moving Average</label><br>
                                                        <label><input type="checkbox" name="technicalConfluence" value="Trendline"> Trendline</label><br>
                                                        <label><input type="checkbox" name="technicalConfluence" value="Fibonacci"> Fibonacci</label><br>
                                                        <label><input type="checkbox" name="technicalConfluence" value="Indicator signal"> Indicator signal</label><br>
                                                        <label><input type="checkbox" name="technicalConfluence" value="Pattern completion"> Pattern completion</label>
                                                    </div>
                                                </div>
                                                <div class="form-group"><label class="form-label">Market Session</label><select name="marketSession" class="form-control"><option value="">Select</option><option>Pre-market</option><option>Market Open (9:30-10:30)</option><option>Mid-morning (10:30-12:00)</option><option>Lunch (12:00-14:00)</option><option>Afternoon (14:00-15:30)</option><option>Market Close (15:30-16:00)</option><option>After-hours</option></select></div>
                                                <div class="form-group"><label class="form-label">Trade Catalyst</label><select name="tradeCatalyst" class="form-control"><option value="">Select</option><option>Technical breakout</option><option>Earnings</option><option>News event</option><option>Sector rotation</option><option>Market reversal</option><option>Momentum follow-through</option><option>Other</option></select></div>
                                            </div>
                                        </div>
                                    </details>

                                    <!-- During Trade Management -->
                                    <details class="collapse-card">
                                        <summary>During Trade Management</summary>
                                        <div class="collapse-content">
                                            <div class="form-grid">
                                                <div class="form-group full-width"><label class="form-label">Did You Wait for Setup?</label>
                                                    <div class="radio-group">
                                                        <label><input type="radio" name="waitedForSetup" value="Yes, completely"> Yes, completely</label><br>
                                                        <label><input type="radio" name="waitedForSetup" value="Partially"> Partially</label><br>
                                                        <label><input type="radio" name="waitedForSetup" value="No, entered early"> No, entered early</label>
                                                    </div>
                                                </div>
                                                <div class="form-group"><label class="form-label">Position Sizing Comfort (1-10)</label><input type="range" name="positionComfort" class="range-input" min="1" max="10" value="5"><div class="range-value">5</div></div>
                                                <div class="form-group"><label class="form-label">Plan Deviation</label><select name="planDeviation" class="form-control"><option value="">Select</option><option>Stuck to plan completely</option><option>Minor deviation</option><option>Major deviation</option><option>Completely changed plan</option></select></div>
                                                <div class="form-group"><label class="form-label">Stress During Trade (1-10)</label><input type="range" name="stressDuring" class="range-input" min="1" max="10" value="1"><div class="range-value">1</div></div>
                                            </div>
                                        </div>
                                    </details>

                                    <!-- Exit Analysis -->
                                    <details class="collapse-card">
                                        <summary>Exit Analysis</summary>
                                        <div class="collapse-content">
                                            <div class="form-grid">
                                                <div class="form-group"><label class="form-label">Primary Exit Reason</label><select name="primaryExitReason" class="form-control"><option value="">Select</option><option>Target hit</option><option>Stop loss hit</option><option>Time-based exit</option><option>Manual profit taking</option><option>Fear-based exit</option><option>Greed-based hold too long</option><option>News/event exit</option><option>Technical signal change</option></select></div>
                                                <div class="form-group"><label class="form-label">Exit Emotion</label><select name="exitEmotion" class="form-control"><option value="">Select</option><option>Satisfied</option><option>Regretful</option><option>Frustrated</option><option>Elated</option><option>Neutral</option><option>Disappointed</option><option>Relieved</option></select></div>
                                                <div class="form-group full-width"><label class="form-label">Would Take Again?</label>
                                                    <div class="radio-group">
                                                        <label><input type="radio" name="wouldTakeAgain" value="Definitely yes"> Definitely yes</label><br>
                                                        <label><input type="radio" name="wouldTakeAgain" value="Probably yes"> Probably yes</label><br>
                                                        <label><input type="radio" name="wouldTakeAgain" value="Maybe"> Maybe</label><br>
                                                        <label><input type="radio" name="wouldTakeAgain" value="Probably no"> Probably no</label><br>
                                                        <label><input type="radio" name="wouldTakeAgain" value="Definitely no"> Definitely no</label>
                                                    </div>
                                                </div>
                                                <div class="form-group full-width"><label class="form-label">Key Lesson Learned</label><textarea name="lesson" class="form-control" rows="3" placeholder="What's the main lesson from this trade?"></textarea></div>
                                            </div>
                                        </div>
                                    </details>

                                    <!-- Market Context -->
                                    <details class="collapse-card">
                                        <summary>Market Context</summary>
                                        <div class="collapse-content">
                                            <div class="form-grid">
                                                <div class="form-group"><label class="form-label">Market Volatility Today</label><select name="volatilityToday" class="form-control"><option value="">Select</option><option>Very high (VIX >30)</option><option>High (VIX 20-30)</option><option>Normal (VIX 15-20)</option><option>Low (VIX <15)</option></select></div>
                                                <div class="form-group"><label class="form-label">Sector Performance</label><select name="sectorPerformance" class="form-control"><option value="">Select</option><option>Sector leading market</option><option>Sector in-line with market</option><option>Sector lagging market</option><option>Sector against market trend</option></select></div>
                                                <div class="form-group full-width"><label class="form-label">Economic Events Today</label>
                                                    <div class="checkbox-group">
                                                        <label><input type="checkbox" name="economicEvents" value="Fed announcement"> Fed announcement</label><br>
                                                        <label><input type="checkbox" name="economicEvents" value="Earnings"> Earnings</label><br>
                                                        <label><input type="checkbox" name="economicEvents" value="Economic data"> Economic data</label><br>
                                                        <label><input type="checkbox" name="economicEvents" value="Geopolitical news"> Geopolitical news</label><br>
                                                        <label><input type="checkbox" name="economicEvents" value="None"> None</label>
                                                    </div>
                                                </div>
                                                <div class="form-group full-width"><label class="form-label">Personal Distractions</label>
                                                    <div class="checkbox-group">
                                                        <label><input type="checkbox" name="personalDistractions" value="Work stress"> Work stress</label><br>
                                                        <label><input type="checkbox" name="personalDistractions" value="Personal issues"> Personal issues</label><br>
                                                        <label><input type="checkbox" name="personalDistractions" value="Health concerns"> Health concerns</label><br>
                                                        <label><input type="checkbox" name="personalDistractions" value="Time pressure"> Time pressure</label><br>
                                                        <label><input type="checkbox" name="personalDistractions" value="None"> None</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </details>
                                    <!-- ====================== End Psychology Sections ====================== -->

                                    <!-- Auto-calculated fields display -->
                                    <div class="calculated-fields">
                                        <h4>Calculated Values</h4>
                                        <div class="calc-grid">
                                            <div class="calc-item"><span class="calc-label">Gross P&L:</span><span class="calc-value" id="calcGrossPL">‚Çπ0</span></div>
                                            <div class="calc-item"><span class="calc-label">Net P&L:</span><span class="calc-value" id="calcNetPL">‚Çπ0</span></div>
                                            <div class="calc-item"><span class="calc-label">Risk:Reward:</span><span class="calc-value" id="calcRiskReward">1:0</span></div>
                                            <div class="calc-item"><span class="calc-label">Capital Risk %:</span><span class="calc-value" id="calcCapitalRisk">0%</span></div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="card__footer add-trade-footer"><button type="button" class="btn btn--outline" id="resetTradeForm">Reset</button><button type="submit" form="addTradeForm" class="btn btn--primary">Save Trade</button></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Trade History Section -->
            <section id="history" class="section"><div class="container"><div class="section-header"><h1>Trade History</h1><div class="filter-controls"><select id="symbolFilter" class="form-control" style="width: 150px;"><option value="">All Symbols</option></select><select id="strategyFilter" class="form-control" style="width: 150px;"><option value="">All Strategies</option></select></div></div><div id="historyContent"><div class="loading">Loading trade history...</div></div></div></section>

            <!-- Analytics Section -->
            <section id="analytics" class="section">
                <div class="container">
                    <div class="section-header"><h1>Analytics & Performance</h1></div>
                    <div class="analytics-summary"><div class="summary-card card"><div class="card__body"><h3>Performance Summary</h3><div class="summary-stats"><div class="summary-item"><span class="label">Total Trades:</span><span class="value" id="analyticsTotalTrades">0</span></div><div class="summary-item"><span class="label">Win Rate:</span><span class="value" id="analyticsWinRate">0%</span></div><div class="summary-item"><span class="label">Net P&L:</span><span class="value" id="analyticsNetPL">‚Çπ0</span></div><div class="summary-item"><span class="label">Best Trade:</span><span class="value" id="analyticsBestTrade">‚Çπ0</span></div><div class="summary-item"><span class="label">Worst Trade:</span><span class="value" id="analyticsWorstTrade">‚Çπ0</span></div><div class="summary-item"><span class="label">Avg Risk:Reward:</span><span class="value" id="analyticsAvgRR">1:0</span></div></div></div></div></div>
                    <!-- Interactive Charts -->
                    <div class="charts-grid">
                        <div class="chart-container" style="position: relative; height: 400px;"><h3>P&L Curve Over Time</h3><canvas id="plChart"></canvas></div>
                        <div class="chart-container" style="position: relative; height: 400px;"><h3>Risk-Reward Distribution</h3><canvas id="rrChart"></canvas></div>
                        <div class="chart-container" style="position: relative; height: 400px;"><h3>Strategy Performance</h3><canvas id="strategyChart"></canvas></div>
                        <div class="chart-container" style="position: relative; height: 400px;"><h3>Time-Based Analysis</h3><canvas id="timeChart"></canvas></div>
                    </div>
                </div>
            </section>

            <!-- AI Suggestions Section -->
            <section id="ai-suggestions" class="section">
                <div class="container">
                    <div class="section-header"><h1>üß† AI Suggestions</h1><p>Personalized insights and recommendations based on your trading data</p></div>
                    <div class="smart-suggestion-banner card"><div class="card__body"><div class="smart-suggestion-content"><h3>üí° Smart Trading Insight</h3><div id="smartInsight" class="smart-suggestion-text">Analyzing your trading patterns...</div></div></div></div>
                    <div class="suggestions-grid"><div class="suggestion-card card"><div class="card__header"><h3>üß† AI-Based Trade Feedback</h3></div><div class="card__body"><div id="aiFeedback" class="suggestion-content">Loading feedback analysis...</div></div></div><div class="suggestion-card card"><div class="card__header"><h3>üìä Personal Trading Edge Analyzer</h3></div><div class="card__body"><div id="edgeAnalyzer" class="suggestion-content">Calculating your trading edge...</div></div></div><div class="suggestion-card card"><div class="card__header"><h3>üìä Daily Confidence Analysis</h3></div><div class="card__body"><div id="confidenceAnalysis" class="suggestion-content">Analyzing confidence patterns...</div><div class="chart-container" style="position: relative; height: 300px; margin-top: 16px;"><canvas id="confidenceChart"></canvas></div></div></div><div class="suggestion-card card"><div class="card__header"><h3>üîÑ Repeat Trade Detection</h3></div><div class="card__body"><div id="repeatTrades" class="suggestion-content">Analyzing for recurring patterns...</div></div></div><div class="suggestion-card card"><div class="card__header"><h3>üéØ Smart Entry Suggestions</h3></div><div class="card__body"><div id="entryAnalysis" class="suggestion-content">Analyzing entry patterns...</div></div></div><div class="suggestion-card card"><div class="card__header"><h3>üßò‚Äç‚ôÇÔ∏è Emotional Bias Tracker</h3></div><div class="card__body"><div id="emotionalBias" class="suggestion-content">Tracking emotional patterns...</div></div></div><div class="suggestion-card card"><div class="card__header"><h3>‚≠ê Setup Quality Score</h3></div><div class="card__body"><div id="setupQuality" class="suggestion-content">Evaluating setup quality...</div></div></div><div class="suggestion-card card"><div class="card__header"><h3>‚è∞ Time-Based Confidence Score</h3></div><div class="card__body"><div id="timeConfidence" class="suggestion-content">Analyzing time-based performance...</div></div></div></div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reports" class="section">
                <div class="container">
                    <div class="section-header"><h1>Reports & Calendar</h1><button class="btn btn--primary" id="exportData">Export to CSV</button></div>
                    <div class="calendar-section card"><div class="card__header"><h3>P&L Calendar</h3><div class="calendar-nav"><button class="btn btn--outline btn--sm" id="prevMonth">‚Äπ</button><span id="currentMonth">July 2025</span><button class="btn btn--outline btn--sm" id="nextMonth">‚Ä∫</button></div></div><div class="card__body"><div id="plCalendar" class="pl-calendar"></div><div class="calendar-legend"><div class="legend-item"><div class="legend-color profit-high"></div><span>High Profit (>‚Çπ1000)</span></div><div class="legend-item"><div class="legend-color profit-low"></div><span>Profit</span></div><div class="legend-item"><div class="legend-color no-trades"></div><span>No Trades</span></div><div class="legend-item"><div class="legend-color loss-low"></div><span>Loss</span></div><div class="legend-item"><div class="legend-color loss-high"></div><span>High Loss (<-‚Çπ1000)</span></div></div></div></div>
                    <div class="reports-grid"><div class="report-card card"><div class="card__body"><h3>Weekly Summary</h3><div id="weeklyReport"><div class="loading">Generating weekly report...</div></div></div></div><div class="report-card card"><div class="card__body"><h3>Monthly Analysis</h3><div id="monthlyReport"><div class="loading">Generating monthly report...</div></div></div></div><div class="report-card card"><div class="card__body"><h3>Strategy Performance</h3><div id="strategyReport"><div class="loading">Analyzing strategies...</div></div></div></div><div class="report-card card"><div class="card__body"><h3>Emotional Patterns</h3><div id="emotionalReport"><div class="loading">Analyzing emotional patterns...</div></div></div></div></div>
                </div>
            </section>
        </main>
        <!-- Trade Detail Modal -->
        <div id="tradeModal" class="modal hidden"><div class="modal-content"><div class="modal-header"><h2>Trade Details</h2><button class="modal-close" onclick="app.hideTradeModal()">&times;</button></div><div class="modal-body" id="tradeModalBody"></div><div class="modal-footer"><button class="btn btn--outline" onclick="app.hideTradeModal()">Close</button><button class="btn btn--primary" id="editTradeBtn">Edit Trade</button></div></div></div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://brjomrasrmbyxepjlfdq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJyam9tcmFzcm1ieXhlcGpsZmRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5NTMwODgsImV4cCI6MjA2OTUyOTA4OH0.51UGb2AE75iE6bPF_mXl_vOBPRB9JiHwFG-7jXyqIrs';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        
        // Trading Journal Application with Supabase Integration
        class TradingJournalApp {
            constructor() {
                this.currentUser = null;
                this.charts = {};

                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.bootstrap());
                } else {
                    this.bootstrap();
                }
            }

            async bootstrap() {
                // Check for existing session
                await this.restoreSession();
                this.setupAuthListeners();
                
                if (this.currentUser) {
                    this.showMainApp();
                } else {
                    this.showAuthScreen();
                }
                
                // Hide loading overlay
                document.getElementById('loadingOverlay').style.display = 'none';
            }

            async restoreSession() {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    // Fetch user profile
                    const { data: profile, error } = await supabase
                        .from('profiles')
                        .select('username')
                        .eq('id', session.user.id)
                        .single();

                    if (error) {
                        console.error('Profile fetch error:', error);
                        return;
                    }

                    this.currentUser = {
                        id: session.user.id,
                        email: session.user.email,
                        username: profile.username,
                        trades: [],
                        confidence: []
                    };

                    // Load user data
                    await this.loadUserData();
                }
            }

            async loadUserData() {
                if (!this.currentUser) return;

                // Load trades
                const { data: trades, error: tradesError } = await supabase
                    .from('trades')
                    .select('*')
                    .eq('user_id', this.currentUser.id)
                    .order('entryDate', { ascending: false });

                if (tradesError) {
                    console.error('Trades load error:', tradesError);
                    this.showToast('Failed to load trades', 'error');
                } else {
                    this.currentUser.trades = trades || [];
                }

                // Load confidence entries
                const { data: confidence, error: confidenceError } = await supabase
                    .from('confidence_entries')
                    .select('*')
                    .eq('user_id', this.currentUser.id)
                    .order('date', { ascending: false });

                if (confidenceError) {
                    console.error('Confidence load error:', confidenceError);
                    this.showToast('Failed to load confidence data', 'error');
                } else {
                    this.currentUser.confidence = confidence || [];
                }
            }

            /* ------------------------------- AUTH ---------------------------------- */
            setupAuthListeners() {
                // Switch tabs
                document.querySelectorAll('.auth-tab').forEach(tab => {
                    tab.addEventListener('click', () => this.switchAuthTab(tab.dataset.tab));
                });

                // Login form
                document.getElementById('loginFormElement').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const fd = new FormData(e.target);
                    const email = fd.get('username').trim();
                    const password = fd.get('password').trim();
                    this.clearAuthErrors();
                    
                    if (!email || !password) {
                        this.showAuthError('login-username-error', 'Please fill all fields');
                        return;
                    }
                    
                    try {
                        await this.login(email, password);
                    } catch (error) {
                        this.showAuthError('login-password-error', error.message);
                    }
                });

                // Signup form
                document.getElementById('signupFormElement').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const fd = new FormData(e.target);
                    const username = fd.get('username').trim();
                    const email = fd.get('email').trim();
                    const password = fd.get('password');
                    const confirm = fd.get('confirmPassword');
                    this.clearAuthErrors();
                    
                    if (!username || !email || !password) {
                        this.showAuthError('signup-username-error', 'Please fill all fields');
                        return;
                    }
                    if (password !== confirm) {
                        this.showAuthError('signup-confirmPassword-error', 'Passwords do not match');
                        return;
                    }

                    try {
                        // 1. Create Supabase auth user
                        const { data: authData, error: authError } = await supabase.auth.signUp({
                            email: email,
                            password: password,
                        });

                        if (authError) throw authError;

                        // 2. Store username in profiles table
                        const { error: profileError } = await supabase
                            .from('profiles')
                            .insert({
                                id: authData.user.id,
                                username: username
                            });

                        if (profileError) throw profileError;

                        alert('Signup successful! Check your email for confirmation.');
                        location.reload();
                        
                    } catch (error) {
                        this.showAuthError('signup-username-error', error.message);
                    }
                });

                // Password reset functionality
                document.getElementById('forgotPassword')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('passwordResetForm').style.display = 'block';
                });

                document.getElementById('backToLogin')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('passwordResetForm').style.display = 'none';
                    document.getElementById('loginForm').style.display = 'block';
                });

                document.getElementById('resetPasswordBtn')?.addEventListener('click', async () => {
                    const email = document.getElementById('resetEmail').value;
                    if (!email) {
                        document.getElementById('reset-email-error').textContent = 'Email is required';
                        return;
                    }
                    
                    const { error } = await supabase.auth.resetPasswordForEmail(email);
                    if (error) {
                        document.getElementById('reset-email-error').textContent = error.message;
                    } else {
                        alert('Password reset link sent to your email!');
                        document.getElementById('passwordResetForm').style.display = 'none';
                        document.getElementById('loginForm').style.display = 'block';
                    }
                });
            }

            async login(email, password) {
                try {
                    // 1. Authenticate with Supabase
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    if (error) throw error;

                    // 2. Fetch user profile (username)
                    const { data: profile, error: profileError } = await supabase
                        .from('profiles')
                        .select('username')
                        .eq('id', data.user.id)
                        .single();

                    if (profileError) throw profileError;

                    // 3. Set current user
                    this.currentUser = {
                        id: data.user.id,
                        email: data.user.email,
                        username: profile.username,
                        trades: [],
                        confidence: []
                    };

                    // 4. Load user data
                    await this.loadUserData();
                    
                    // 5. Show welcome message and main app
                    this.showToast('Welcome, ' + this.currentUser.username + '!', 'success');
                    this.showMainApp();

                } catch (error) {
                    throw new Error('Login failed: ' + error.message);
                }
            }

            async logout() {
                await supabase.auth.signOut();
                this.currentUser = null;
                Object.values(this.charts).forEach(chart => chart && chart.destroy && chart.destroy());
                this.charts = {};
                this.showAuthScreen();
                this.showToast('Logged out successfully', 'success');
            }

            /* ------------------------------ VIEW SWITCH --------------------------- */
            showAuthScreen() {
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('mainApp').classList.add('hidden');
            }

            showMainApp() {
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainApp').classList.remove('hidden');

                if (!this.mainListenersAttached) {
                    this.attachMainListeners();
                    this.mainListenersAttached = true;
                }

                this.updateUserInfo();
                this.showSection('dashboard');
            }

            attachMainListeners() {
                document.querySelectorAll('.nav-link').forEach(btn => {
                    btn.addEventListener('click', () => this.showSection(btn.dataset.section));
                });
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                document.getElementById('themeToggle').addEventListener('click', () => this.toggleTheme());
                document.getElementById('quickAddTrade').addEventListener('click', () => this.showSection('add-trade'));

                // Daily confidence slider
                const slider = document.getElementById('dailyConfidence');
                const out = document.getElementById('confidenceValue');
                slider.addEventListener('input', () => (out.textContent = slider.value));
                document.getElementById('saveConfidenceBtn').addEventListener('click', () => this.saveDailyConfidence());

                // Add trade form setup
                this.setupAddTradeForm();

                // Export
                document.getElementById('exportData').addEventListener('click', () => this.exportCSV());

                // Calendar nav
                document.getElementById('prevMonth').addEventListener('click', () => this.changeCalendarMonth(-1));
                document.getElementById('nextMonth').addEventListener('click', () => this.changeCalendarMonth(1));

                // Custom event for confidence update
                document.addEventListener('confidence-updated', () => {
                    if (document.getElementById('ai-suggestions').classList.contains('active')) {
                        this.renderAISuggestions();
                    }
                    if (document.getElementById('reports').classList.contains('active')) {
                        this.renderReports();
                    }
                });
            }

            updateUserInfo() {
                document.getElementById('currentUserName').textContent = this.currentUser.username;
            }

            toggleTheme() {
                const html = document.documentElement;
                const current = html.getAttribute('data-color-scheme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                const next = current === 'dark' ? 'light' : 'dark';
                html.setAttribute('data-color-scheme', next);
                document.getElementById('themeToggle').textContent = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }

            showSection(id) {
                document.querySelectorAll('.nav-link').forEach(btn => btn.classList.toggle('active', btn.dataset.section === id));
                document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
                document.getElementById(id).classList.add('active');

                switch (id) {
                    case 'dashboard':
                        this.renderDashboard();
                        break;
                    case 'add-trade':
                        this.renderAddTrade();
                        break;
                    case 'history':
                        this.renderHistory();
                        break;
                    case 'analytics':
                        this.renderAnalytics();
                        break;
                    case 'ai-suggestions':
                        this.renderAISuggestions();
                        break;
                    case 'reports':
                        this.renderReports();
                        break;
                }
            }

            /* ------------------------------ HELPERS ------------------------------- */
            formatCurrency(val) {
                const sign = val < 0 ? '-' : '';
                return sign + '‚Çπ' + Math.abs(val).toLocaleString('en-IN', { minimumFractionDigits: 2 });
            }

            formatDate(str) {
                return new Date(str).toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: '2-digit' });
            }

            showToast(msg, type = 'info') {
                const container = document.getElementById('toastContainer');
                const div = document.createElement('div');
                div.className = 'toast ' + type;
                div.textContent = msg;
                container.appendChild(div);
                setTimeout(() => div.remove(), 3000);
            }

            /* ---------------------- DASHBOARD RENDER ----------------------------- */
            get trades() {
                return this.currentUser ? this.currentUser.trades : [];
            }

            get confidenceEntries() {
                return this.currentUser ? this.currentUser.confidence : [];
            }

            calculateStats() {
                if (this.trades.length === 0) {
                    return { totalPL: 0, winRate: 0, totalTrades: 0, avgRR: '1:0', bestTrade: 0, worstTrade: 0 };
                }
                const totalPL = this.trades.reduce((sum, t) => sum + (t.netPL || 0), 0);
                const wins = this.trades.filter(t => t.netPL > 0).length;
                const winRate = Math.round((wins / this.trades.length) * 100);
                const bestTrade = Math.max(...this.trades.map(t => t.netPL));
                const worstTrade = Math.min(...this.trades.map(t => t.netPL));
                const avgRRNum = (
                    this.trades.filter(t => t.riskRewardRatio !== undefined).reduce((sum, t, _, arr) => sum + t.riskRewardRatio / arr.length, 0)
                ).toFixed(2);
                return { totalPL, winRate, totalTrades: this.trades.length, avgRR: '1:' + avgRRNum, bestTrade, worstTrade };
            }

            renderDashboard() {
                const s = this.calculateStats();
                const totalPLEl = document.getElementById('totalPL');
                totalPLEl.textContent = this.formatCurrency(s.totalPL);
                totalPLEl.className = 'stat-value ' + (s.totalPL >= 0 ? 'positive' : 'negative');
                document.getElementById('winRate').textContent = s.winRate + '%';
                document.getElementById('totalTrades').textContent = s.totalTrades;
                document.getElementById('avgRR').textContent = s.avgRR;

                // Recent trades list
                const list = document.getElementById('recentTradesList');
                if (this.trades.length === 0) {
                    list.innerHTML = '<div class="empty-state">No trades yet. Click "Add New Trade" to get started!</div>';
                    return;
                }
                list.innerHTML = this.trades.slice(0, 5).map(t => `
                    <div class="trade-item" onclick="app.showTradeDetails('${t.id}')">
                        <div class="trade-info">
                            <span class="trade-symbol">${t.symbol}</span>
                            <span class="trade-direction ${t.direction.toLowerCase()}">${t.direction}</span>
                            <span class="trade-date">${this.formatDate(t.entryDate)}</span>
                        </div>
                        <div class="trade-pl ${t.netPL >= 0 ? 'positive' : 'negative'}">${this.formatCurrency(t.netPL)}</div>
                    </div>`).join('');
            }

            async saveDailyConfidence() {
                const level = parseInt(document.getElementById('dailyConfidence').value, 10);
                const today = new Date().toISOString().split('T')[0];
                
                // Check if entry already exists for today
                const existing = this.currentUser.confidence.find(c => c.date === today);
                if (existing) {
                    this.showToast("You've already recorded confidence today!", 'warning');
                    return;
                }

                try {
                    // Save to Supabase
                    const { error } = await supabase
                        .from('confidence_entries')
                        .insert({
                            user_id: this.currentUser.id,
                            date: today,
                            level: level
                        });

                    if (error) throw error;

                    // Update local state
                    this.currentUser.confidence.push({ date: today, level });
                    document.getElementById('confidenceMessage').innerHTML = "<div class='message success'>Daily confidence recorded successfully!</div>";
                    this.showToast('Daily confidence recorded successfully!', 'success');
                    document.dispatchEvent(new CustomEvent('confidence-updated', { detail: { date: today, level } }));
                    
                } catch (error) {
                    console.error('Save confidence error:', error);
                    this.showToast('Failed to save confidence: ' + error.message, 'error');
                }
            }

            /* ----------------------- ADD TRADE FORM ------------------------------ */
            renderAddTrade() {
                const now = new Date();
                const entryDateEl = document.querySelector('input[name="entryDate"]');
                const exitDateEl = document.querySelector('input[name="exitDate"]');
                if (entryDateEl && !entryDateEl.value) entryDateEl.value = now.toISOString().slice(0, 16);
                if (exitDateEl && !exitDateEl.value) exitDateEl.value = new Date(now.getTime() + 4 * 60 * 60 * 1000).toISOString().slice(0, 16);
            }

            setupAddTradeForm() {
                const form = document.getElementById('addTradeForm');
                
                // Setup all range inputs with their corresponding value displays
                const rangeInputs = [
                    { name: 'confidenceLevel', displayId: 'tradeConfidenceValue' },
                    { name: 'sleepQuality', displayClass: 'range-value' },
                    { name: 'physicalCondition', displayClass: 'range-value' },
                    { name: 'fomoLevel', displayClass: 'range-value' },
                    { name: 'preStress', displayClass: 'range-value' },
                    { name: 'positionComfort', displayClass: 'range-value' },
                    { name: 'stressDuring', displayClass: 'range-value' }
                ];

                rangeInputs.forEach(input => {
                    const slider = form.querySelector(`[name="${input.name}"]`);
                    if (slider) {
                        const display = input.displayId ? 
                            document.getElementById(input.displayId) : 
                            slider.parentElement.querySelector('.range-value');
                        
                        if (display) {
                            slider.addEventListener('input', () => (display.textContent = slider.value));
                        }
                    }
                });

                const calcFields = ['quantity', 'entryPrice', 'exitPrice', 'stopLoss', 'targetPrice', 'direction'];
                calcFields.forEach(name => {
                    const field = form.querySelector(`[name="${name}"]`);
                    if (field) {
                        field.addEventListener('input', () => this.updateCalculations());
                        field.addEventListener('change', () => this.updateCalculations());
                    }
                });

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.submitTrade();
                });

                document.getElementById('resetTradeForm').addEventListener('click', () => {
                    form.reset();
                    this.updateCalculations();
                    this.renderAddTrade();
                    // Reset all range value displays
                    document.querySelectorAll('.range-value').forEach(el => el.textContent = '5');
                    const tradeConfidenceValue = document.getElementById('tradeConfidenceValue');
                    if (tradeConfidenceValue) tradeConfidenceValue.textContent = '5';
                });
            }

            updateCalculations() {
                const fd = new FormData(document.getElementById('addTradeForm'));
                const qty = parseFloat(fd.get('quantity')) || 0;
                const entry = parseFloat(fd.get('entryPrice')) || 0;
                const exit = parseFloat(fd.get('exitPrice')) || 0;
                const sl = parseFloat(fd.get('stopLoss')) || 0;
                const target = parseFloat(fd.get('targetPrice')) || 0;
                const dir = fd.get('direction');

                let gross = 0;
                if (qty && entry && exit) {
                    gross = dir === 'Long' ? (exit - entry) * qty : (entry - exit) * qty;
                }
                const net = gross - 40; // assume brokerage

                let riskReward = 0;
                if (qty && entry && sl) {
                    const risk = Math.abs(entry - sl) * qty;
                    const reward = target ? Math.abs((dir === 'Long' ? target - entry : entry - target)) * qty : Math.abs(gross);
                    if (risk > 0) riskReward = reward / risk;
                }

                // Capital risk % (assume capital 100k for demo)
                const capitalRisk = ((Math.abs(entry - sl) * qty) / 100000) * 100 || 0;

                // Update UI
                const setVal = (id, val, pos) => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.textContent = val;
                        if (pos !== undefined) el.className = 'calc-value ' + (pos ? 'positive' : 'negative');
                    }
                };
                setVal('calcGrossPL', this.formatCurrency(gross), gross >= 0);
                setVal('calcNetPL', this.formatCurrency(net), net >= 0);
                const rrEl = document.getElementById('calcRiskReward');
                if (rrEl) rrEl.textContent = '1:' + riskReward.toFixed(2);
                const crEl = document.getElementById('calcCapitalRisk');
                if (crEl) crEl.textContent = capitalRisk.toFixed(2) + '%';
            }

            // Helper function to get checkbox values
            getCheckboxValues(name) {
                const checkboxes = document.querySelectorAll(`input[name="${name}"]:checked`);
                return Array.from(checkboxes).map(cb => cb.value);
            }

            // Helper function to get radio value
            getRadioValue(name) {
                const radio = document.querySelector(`input[name="${name}"]:checked`);
                return radio ? radio.value : '';
            }

            async submitTrade() {
                const form = document.getElementById('addTradeForm');
                const fd = new FormData(form);
                // Clear prev errors
                form.querySelectorAll('.form-error').forEach(e => {
                    e.textContent = '';
                    e.classList.remove('active');
                });

                // Validate required fields
                const required = ['symbol', 'direction', 'quantity', 'entryPrice', 'exitPrice', 'entryDate', 'exitDate'];
                let hasErr = false;
                required.forEach(field => {
                    const val = fd.get(field);
                    if (!val || val.toString().trim() === '') {
                        const errEl = document.getElementById(field + '-error');
                        if (errEl) {
                            errEl.textContent = 'Required';
                            errEl.classList.add('active');
                        }
                        hasErr = true;
                    }
                });

                const qty = parseFloat(fd.get('quantity'));
                if (isNaN(qty) || qty <= 0) {
                    const errEl = document.getElementById('quantity-error');
                    if (errEl) {
                        errEl.textContent = 'Must be positive';
                        errEl.classList.add('active');
                    }
                    hasErr = true;
                }

                const entryDate = new Date(fd.get('entryDate'));
                const exitDate = new Date(fd.get('exitDate'));
                if (exitDate <= entryDate) {
                    const errEl = document.getElementById('exitDate-error');
                    if (errEl) {
                        errEl.textContent = 'Exit after entry';
                        errEl.classList.add('active');
                    }
                    hasErr = true;
                }

                if (hasErr) {
                    this.showToast('Please fix errors', 'error');
                    return;
                }

                // Build comprehensive trade object with all psychology fields
                const trade = {
                    // Basic trade details
                    symbol: fd.get('symbol').toUpperCase(),
                    direction: fd.get('direction'),
                    quantity: qty,
                    entryPrice: parseFloat(fd.get('entryPrice')),
                    exitPrice: parseFloat(fd.get('exitPrice')),
                    stopLoss: parseFloat(fd.get('stopLoss')) || null,
                    targetPrice: parseFloat(fd.get('targetPrice')) || null,
                    strategy: fd.get('strategy') || 'N/A',
                    exitReason: fd.get('exitReason') || 'N/A',
                    confidenceLevel: parseInt(fd.get('confidenceLevel')),
                    entryDate: fd.get('entryDate'),
                    exitDate: fd.get('exitDate'),
                    preEmotion: fd.get('preEmotion') || '',
                    postEmotion: fd.get('postEmotion') || '',
                    notes: fd.get('notes') || '',

                    // Pre-Trade Psychology
                    sleepQuality: parseInt(fd.get('sleepQuality')) || 5,
                    physicalCondition: parseInt(fd.get('physicalCondition')) || 5,
                    marketSentiment: fd.get('marketSentiment') || '',
                    newsAwareness: fd.get('newsAwareness') || '',
                    marketEnvironment: fd.get('marketEnvironment') || '',
                    fomoLevel: parseInt(fd.get('fomoLevel')) || 1,
                    preStress: parseInt(fd.get('preStress')) || 1,

                    // Trade Setup Analysis
                    multiTimeframes: this.getCheckboxValues('multiTimeframes'),
                    volumeAnalysis: fd.get('volumeAnalysis') || '',
                    technicalConfluence: this.getCheckboxValues('technicalConfluence'),
                    marketSession: fd.get('marketSession') || '',
                    tradeCatalyst: fd.get('tradeCatalyst') || '',

                    // During Trade Management
                    waitedForSetup: this.getRadioValue('waitedForSetup'),
                    positionComfort: parseInt(fd.get('positionComfort')) || 5,
                    planDeviation: fd.get('planDeviation') || '',
                    stressDuring: parseInt(fd.get('stressDuring')) || 1,

                    // Exit Analysis
                    primaryExitReason: fd.get('primaryExitReason') || '',
                    exitEmotion: fd.get('exitEmotion') || '',
                    wouldTakeAgain: this.getRadioValue('wouldTakeAgain'),
                    lesson: fd.get('lesson') || '',

                    // Market Context
                    volatilityToday: fd.get('volatilityToday') || '',
                    sectorPerformance: fd.get('sectorPerformance') || '',
                    economicEvents: this.getCheckboxValues('economicEvents'),
                    personalDistractions: this.getCheckboxValues('personalDistractions')
                };

                // Calculate P&L and RR
                trade.grossPL = trade.direction === 'Long' ? (trade.exitPrice - trade.entryPrice) * trade.quantity : (trade.entryPrice - trade.exitPrice) * trade.quantity;
                trade.netPL = trade.grossPL - 40;
                if (trade.stopLoss) {
                    const risk = Math.abs(trade.entryPrice - trade.stopLoss) * trade.quantity;
                    const reward = trade.targetPrice ? Math.abs((trade.direction === 'Long') ? trade.targetPrice - trade.entryPrice : trade.entryPrice - trade.targetPrice) * trade.quantity : Math.abs(trade.grossPL);
                    trade.riskRewardRatio = risk ? reward / risk : 0;
                } else trade.riskRewardRatio = 0;

                try {
                    // Save to Supabase
                    const { data, error } = await supabase
                        .from('trades')
                        .insert([{
                            ...trade,
                            user_id: this.currentUser.id
                        }])
                        .select();

                    if (error) throw error;

                    // Add to local state
                    const savedTrade = { ...trade, id: data[0].id };
                    this.currentUser.trades.unshift(savedTrade);
                    
                    this.showToast('Trade saved with enhanced psychology data!', 'success');
                    form.reset();
                    this.updateCalculations();
                    this.renderAddTrade();
                    
                    // Reset all range value displays
                    document.querySelectorAll('.range-value').forEach(el => el.textContent = '5');
                    const tradeConfidenceValue = document.getElementById('tradeConfidenceValue');
                    if (tradeConfidenceValue) tradeConfidenceValue.textContent = '5';
                    
                    this.showSection('dashboard');
                    
                } catch (error) {
                    console.error('Save trade error:', error);
                    this.showToast('Failed to save trade: ' + error.message, 'error');
                }
            }

            /* ---------------------------- HISTORY ------------------------------- */
            renderHistory() {
                const container = document.getElementById('historyContent');
                if (this.trades.length === 0) {
                    container.innerHTML = '<div class="empty-state">No trades recorded yet.</div>';
                    return;
                }

                // Populate filters
                const symbols = [...new Set(this.trades.map(t => t.symbol))];
                const symbolFilter = document.getElementById('symbolFilter');
                symbolFilter.innerHTML = '<option value="">All Symbols</option>' + symbols.map(s => `<option value="${s}">${s}</option>`).join('');

                const strategies = [...new Set(this.trades.map(t => t.strategy))];
                const strategyFilter = document.getElementById('strategyFilter');
                strategyFilter.innerHTML = '<option value="">All Strategies</option>' + strategies.map(s => `<option value="${s}">${s}</option>`).join('');

                const applyFilters = () => {
                    const symVal = symbolFilter.value;
                    const stratVal = strategyFilter.value;
                    const filtered = this.trades.filter(t => (!symVal || t.symbol === symVal) && (!stratVal || t.strategy === stratVal));
                    renderTable(filtered);
                };

                symbolFilter.onchange = strategyFilter.onchange = applyFilters;

                const renderTable = rows => {
                    if (rows.length === 0) {
                        container.innerHTML = '<div class="empty-state">No trades match filter.</div>';
                        return;
                    }
                    container.innerHTML = `
                        <div class="card"><table class="trade-table"><thead>
                            <tr><th>Date</th><th>Symbol</th><th>Dir</th><th>Qty</th><th>Entry</th><th>Exit</th><th>P&L</th><th>Strategy</th></tr>
                        </thead><tbody>
                            ${rows.sort((a,b) => new Date(b.entryDate) - new Date(a.entryDate)).map(t => `
                                <tr onclick="app.showTradeDetails('${t.id}')">
                                    <td data-label="Date">${this.formatDate(t.entryDate)}</td>
                                    <td data-label="Symbol">${t.symbol}</td>
                                    <td data-label="Direction"><span class="trade-direction ${t.direction.toLowerCase()}">${t.direction}</span></td>
                                    <td data-label="Qty">${t.quantity}</td>
                                    <td data-label="Entry">‚Çπ${t.entryPrice}</td>
                                    <td data-label="Exit">‚Çπ${t.exitPrice}</td>
                                    <td data-label="P&L" class="${t.netPL>=0?'positive':'negative'}">${this.formatCurrency(t.netPL)}</td>
                                    <td data-label="Strategy">${t.strategy}</td>
                                </tr>`).join('')}
                        </tbody></table></div>`;
                };

                applyFilters();
            }

            /* -------------------------- ANALYTICS ------------------------------ */
            renderAnalytics() {
                const s = this.calculateStats();
                document.getElementById('analyticsTotalTrades').textContent = s.totalTrades;
                document.getElementById('analyticsWinRate').textContent = s.winRate + '%';
                const netEl = document.getElementById('analyticsNetPL');
                netEl.textContent = this.formatCurrency(s.totalPL);
                netEl.className = 'value ' + (s.totalPL >= 0 ? 'positive' : 'negative');
                document.getElementById('analyticsBestTrade').textContent = this.formatCurrency(s.bestTrade);
                document.getElementById('analyticsWorstTrade').textContent = this.formatCurrency(s.worstTrade);
                document.getElementById('analyticsAvgRR').textContent = s.avgRR;

                if (typeof Chart === 'undefined') return;

                setTimeout(() => {
                    this.drawPLChart();
                    this.drawRRChart();
                    this.drawStrategyChart();
                    this.renderTimeTables();
                }, 30);
            }

            drawPLChart() {
                const ctx = document.getElementById('plChart');
                if (!ctx) return;
                this.charts.pl && this.charts.pl.destroy();
                if (this.trades.length === 0) { ctx.getContext('2d').clearRect(0,0,ctx.width,ctx.height); return; }

                const sorted = [...this.trades].sort((a,b) => new Date(a.entryDate) - new Date(b.entryDate));
                const labels = [];
                const cum = [];
                let run = 0;
                sorted.forEach(t => { run += t.netPL; labels.push(this.formatDate(t.entryDate)); cum.push(run); });

                this.charts.pl = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets:[{ label:'Cumulative P&L', data:cum, borderColor:'#1FB8CD', backgroundColor:'rgba(31,184,205,0.15)', tension:0.4, fill:true }] },
                    options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, ticks:{ callback:v=>'‚Çπ'+v.toLocaleString('en-IN') } } } }
                });
            }

            drawRRChart() {
                const ctx = document.getElementById('rrChart');
                if (!ctx) return;
                this.charts.rr && this.charts.rr.destroy();
                if (this.trades.length === 0) { ctx.getContext('2d').clearRect(0,0,ctx.width,ctx.height); return; }

                const buckets = { '<1:1':0, '1:1-1:2':0, '1:2-1:3':0, '>1:3':0 };
                this.trades.forEach(t => {
                    const rr = t.riskRewardRatio || 0;
                    if (rr < 1) buckets['<1:1']++; else if (rr < 2) buckets['1:1-1:2']++; else if (rr < 3) buckets['1:2-1:3']++; else buckets['>1:3']++;
                });

                this.charts.rr = new Chart(ctx, {
                    type: 'bar',
                    data: { labels:Object.keys(buckets), datasets:[{ data:Object.values(buckets), backgroundColor:['#FFC185','#B4413C','#5D878F','#1FB8CD'] }] },
                    options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
                });
            }

            drawStrategyChart() {
                const ctx = document.getElementById('strategyChart');
                if (!ctx) return;
                this.charts.strategy && this.charts.strategy.destroy();
                if (this.trades.length===0){ ctx.getContext('2d').clearRect(0,0,ctx.width,ctx.height); return; }

                const map = {};
                this.trades.forEach(t => {
                    if(!map[t.strategy]) map[t.strategy]={ total:0, wins:0 };
                    map[t.strategy].total++;
                    if(t.netPL>0) map[t.strategy].wins++;
                });
                const labels = Object.keys(map);
                const data = labels.map(l => Math.round((map[l].wins / map[l].total) * 100));

                this.charts.strategy = new Chart(ctx, {
                    type:'bar',
                    data:{ labels, datasets:[{ data, backgroundColor:'#1FB8CD' }] },
                    options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, max:100, ticks:{ callback:v=>v+'%' }}}}
                });
            }

            renderTimeTables() {
                const container = document.getElementById('timeChart').parentElement;
                container.querySelectorAll('.time-table').forEach(n=>n.remove());
                if (this.trades.length===0) return;

                const monthMap = {};
                const dowNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
                const dowMap = Object.fromEntries(dowNames.map(d=>[d,{total:0,wins:0,net:0}]));

                this.trades.forEach(t => {
                    const d = new Date(t.entryDate);
                    const mKey = `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}`;
                    if(!monthMap[mKey]) monthMap[mKey]={total:0,wins:0,net:0};
                    monthMap[mKey].total++;
                    if(t.netPL>0) monthMap[mKey].wins++;
                    monthMap[mKey].net+=t.netPL;

                    const dow = dowNames[d.getDay()];
                    dowMap[dow].total++;
                    if(t.netPL>0) dowMap[dow].wins++;
                    dowMap[dow].net+=t.netPL;
                });

                const makeTable = (title, rows) => {
                    const div = document.createElement('div');
                    div.className='time-table';
                    div.innerHTML=`<h4>${title}</h4><table class="trade-table"><thead><tr><th>Period</th><th>Trades</th><th>Win %</th><th>Net P&L</th></tr></thead><tbody>${rows}</tbody></table>`;
                    container.appendChild(div);
                };

                const monthRows = Object.keys(monthMap).sort().map(k => {
                    const o=monthMap[k];
                    const win=Math.round((o.wins/o.total)*100);
                    return `<tr><td>${k}</td><td>${o.total}</td><td>${win}%</td><td class="${o.net>=0?'positive':'negative'}">${this.formatCurrency(o.net)}</td></tr>`;
                }).join('');
                makeTable('Monthly Performance', monthRows);

                const dowRows = dowNames.filter(d=>dowMap[d].total>0).map(d=>{
                    const o=dowMap[d];
                    const win=Math.round((o.wins/o.total)*100);
                    return `<tr><td>${d}</td><td>${o.total}</td><td>${win}%</td><td class="${o.net>=0?'positive':'negative'}">${this.formatCurrency(o.net)}</td></tr>`;
                }).join('');
                makeTable('Day-of-Week Analysis', dowRows);
            }

            /* ----------------------- AI SUGGESTIONS ----------------------------- */
            renderAISuggestions() {
                const s = this.calculateStats();
                document.getElementById('smartInsight').textContent = s.totalPL>=0 ?
                    `Great job! You're net positive ${this.formatCurrency(s.totalPL)} with a ${s.winRate}% win rate.` :
                    `You're net negative ${this.formatCurrency(s.totalPL)}. Focus on risk management and psychology.`;

                // Enhanced AI feedback with psychology analysis
                const fb = document.getElementById('aiFeedback');
                let psychologyInsight = '';
                if (this.trades.length > 0) {
                    const avgStress = this.trades.reduce((sum, t) => sum + (t.preStress || 0), 0) / this.trades.length;
                    const avgFomo = this.trades.reduce((sum, t) => sum + (t.fomoLevel || 0), 0) / this.trades.length;
                    const avgSleep = this.trades.reduce((sum, t) => sum + (t.sleepQuality || 0), 0) / this.trades.length;
                    
                    if (avgStress > 6) psychologyInsight += ' High stress levels detected.';
                    if (avgFomo > 6) psychologyInsight += ' FOMO affecting decisions.';
                    if (avgSleep < 6) psychologyInsight += ' Poor sleep impacting performance.';
                }

                fb.innerHTML = `<div class="suggestion-item ${s.winRate>=60?'suggestion-success':s.winRate>=40?'suggestion-info':'suggestion-warning'}">
                    <div class="suggestion-title">${s.winRate>=60?'Excellent Execution':s.winRate>=40?'Moderate Execution':'Poor Execution'}</div>
                    <div class="suggestion-desc">Win rate ${s.winRate}% over ${s.totalTrades} trades.${psychologyInsight}</div></div>`;

                const bestStrat = this.bestStrategy();
                document.getElementById('edgeAnalyzer').innerHTML = `<div class="suggestion-item suggestion-info"><div class="suggestion-title">Best Strategy</div><div class="suggestion-desc">${bestStrat}</div></div>`;

                const confEl = document.getElementById('confidenceAnalysis');
                if (this.confidenceEntries.length===0) {
                    confEl.innerHTML = '<div class="suggestion-item suggestion-info"><div class="suggestion-title">No Confidence Data</div><div class="suggestion-desc">Record daily confidence.</div></div>';
                } else {
                    const avg = (this.confidenceEntries.reduce((sum,c)=>sum+c.level,0)/this.confidenceEntries.length).toFixed(1);
                    confEl.innerHTML = `<div class="suggestion-item suggestion-info"><div class="suggestion-title">Avg Confidence</div><div class="suggestion-desc">${avg}/10 over ${this.confidenceEntries.length} days</div></div>`;
                    this.drawConfidenceChart();
                }

                document.getElementById('repeatTrades').innerHTML = this.repeatTradeHTML();
                
                // Enhanced entry analysis with new psychology data
                const entryAnalysis = this.analyzeEntryPatterns();
                document.getElementById('entryAnalysis').innerHTML = entryAnalysis;
                
                // Enhanced emotional bias analysis
                const emotionalBias = this.analyzeEmotionalBias();
                document.getElementById('emotionalBias').innerHTML = emotionalBias;
                
                document.getElementById('setupQuality').innerHTML = '<div class="suggestion-item suggestion-info">Setup quality scoring coming soon.</div>';
                document.getElementById('timeConfidence').innerHTML = '<div class="suggestion-item suggestion-info">Time-based confidence insights coming soon.</div>';
            }

            analyzeEntryPatterns() {
                if (this.trades.length < 3) return '<div class="suggestion-item suggestion-info">Need more trades for entry pattern analysis.</div>';
                
                const waitedTrades = this.trades.filter(t => t.waitedForSetup === 'Yes, completely');
                const waitedWinRate = waitedTrades.length ? Math.round((waitedTrades.filter(t => t.netPL > 0).length / waitedTrades.length) * 100) : 0;
                const rushed = this.trades.filter(t => t.waitedForSetup === 'No, entered early').length;
                
                return `<div class="suggestion-item ${waitedWinRate > 60 ? 'suggestion-success' : 'suggestion-warning'}">
                    <div class="suggestion-title">Entry Discipline Analysis</div>
                    <div class="suggestion-desc">When you wait for setup: ${waitedWinRate}% win rate. Rushed entries: ${rushed} trades.</div>
                </div>`;
            }

            analyzeEmotionalBias() {
                if (this.trades.length < 3) return '<div class="suggestion-item suggestion-info">Need more trades for emotional analysis.</div>';
                
                const highFomoTrades = this.trades.filter(t => (t.fomoLevel || 0) > 6);
                const highStressTrades = this.trades.filter(t => (t.preStress || 0) > 6);
                
                let analysis = '';
                if (highFomoTrades.length > 0) {
                    const fomoWinRate = Math.round((highFomoTrades.filter(t => t.netPL > 0).length / highFomoTrades.length) * 100);
                    analysis += `High FOMO trades: ${fomoWinRate}% win rate. `;
                }
                if (highStressTrades.length > 0) {
                    const stressWinRate = Math.round((highStressTrades.filter(t => t.netPL > 0).length / highStressTrades.length) * 100);
                    analysis += `High stress trades: ${stressWinRate}% win rate.`;
                }
                
                if (!analysis) analysis = 'Good emotional control detected in your trades.';
                
                return `<div class="suggestion-item suggestion-info">
                    <div class="suggestion-title">Emotional Impact</div>
                    <div class="suggestion-desc">${analysis}</div>
                </div>`;
            }

            repeatTradeHTML() {
                if (this.trades.length<3) return '<div class="suggestion-item suggestion-info">Need more trades for pattern detection.</div>';
                const freq = {};
                this.trades.forEach(t=>freq[t.symbol]=(freq[t.symbol]||0)+1);
                const [sym,count] = Object.entries(freq).sort((a,b)=>b[1]-a[1])[0];
                return `<div class="suggestion-item suggestion-info"><div class="suggestion-title">Most Traded Symbol</div><div class="suggestion-desc">${sym} (${count} trades)</div></div>`;
            }

            drawConfidenceChart() {
                const ctx = document.getElementById('confidenceChart');
                if (!ctx) return;
                this.charts.conf && this.charts.conf.destroy();

                const sorted = [...this.confidenceEntries].sort((a,b)=>new Date(a.date)-new Date(b.date));
                this.charts.conf = new Chart(ctx,{ type:'line', data:{ labels:sorted.map(c=>c.date), datasets:[{ data:sorted.map(c=>c.level), borderColor:'#1FB8CD', backgroundColor:'rgba(31,184,205,0.15)', tension:0.3, fill:true }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ min:1, max:10 } } } });
            }

            /* ------------------------ REPORTS & CALENDAR ------------------------ */
            renderReports() {
                // Basic summaries
                const s = this.calculateStats();
                document.getElementById('weeklyReport').innerHTML = `<div class="report-item"><span class="report-label">Total Trades</span><span class="report-value">${s.totalTrades}</span></div><div class="report-item"><span class="report-label">Win Rate</span><span class="report-value">${s.winRate}%</span></div>`;
                document.getElementById('monthlyReport').innerHTML = `<div class="report-item"><span class="report-label">Net P&L</span><span class="report-value ${s.totalPL>=0?'positive':'negative'}">${this.formatCurrency(s.totalPL)}</span></div>`;
                document.getElementById('strategyReport').innerHTML = `<div class="report-item"><span class="report-label">Best Strategy</span><span class="report-value">${this.bestStrategy()}</span></div>`;
                const avgConf = this.confidenceEntries.length ? (this.confidenceEntries.reduce((sum,c)=>sum+c.level,0)/this.confidenceEntries.length).toFixed(1) : 'N/A';
                document.getElementById('emotionalReport').innerHTML = `<div class="report-item"><span class="report-label">Avg Confidence</span><span class="report-value">${avgConf}/10</span></div>`;

                // Calendar
                this.currentCalendarDate = this.currentCalendarDate || new Date();
                this.buildCalendar();
            }

            changeCalendarMonth(offset) {
                this.currentCalendarDate.setMonth(this.currentCalendarDate.getMonth()+offset);
                this.buildCalendar();
            }

            buildCalendar() {
                const date = this.currentCalendarDate;
                const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
                const monthEnd = new Date(date.getFullYear(), date.getMonth()+1, 0);
                const daysInMonth = monthEnd.getDate();

                document.getElementById('currentMonth').textContent = monthStart.toLocaleDateString('en-IN', { month:'long', year:'numeric' });
                const cal = document.getElementById('plCalendar');
                cal.innerHTML='';

                const dowNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
                dowNames.forEach(d=>{
                    const div=document.createElement('div');
                    div.className='calendar-day header';
                    div.textContent=d;
                    cal.appendChild(div);
                });

                // Empty days before start
                for(let i=0;i<monthStart.getDay();i++){
                    const div=document.createElement('div');
                    div.className='calendar-day no-trades';
                    cal.appendChild(div);
                }

                for(let d=1;d<=daysInMonth;d++){
                    const current = new Date(date.getFullYear(), date.getMonth(), d);
                    const key = current.toISOString().split('T')[0];
                    const trades = this.trades.filter(t => t.entryDate.startsWith(key));
                    let cls = 'no-trades';
                    let content = d;
                    if (trades.length) {
                        const pl = trades.reduce((sum,t)=>sum+t.netPL,0);
                        if (pl>1000) cls='profit-high'; else if (pl>0) cls='profit-low'; else if (pl<-1000) cls='loss-high'; else cls='loss-low';
                        content = d;
                    }
                    const div=document.createElement('div');
                    div.className='calendar-day '+cls;
                    div.textContent=content;
                    div.title = trades.length ? `${trades.length} trades, P&L: ${this.formatCurrency(trades.reduce((s,t)=>s+t.netPL,0))}` : 'No trades';
                    if(trades.length){ div.onclick=()=>alert('Trades for '+key+' will be detailed in future update.'); }
                    cal.appendChild(div);
                }
            }

            /* ------------------------ UTIL ------------------------------------- */
            bestStrategy() {
                if (this.trades.length===0) return 'N/A';
                const map={};
                this.trades.forEach(t=>map[t.strategy]=(map[t.strategy]||0)+t.netPL);
                return Object.entries(map).sort((a,b)=>b[1]-a[1])[0][0];
            }

            exportCSV() {
                if (this.trades.length===0) { this.showToast('No trades to export','warning'); return; }
                const header=['Date','Symbol','Direction','Qty','Entry','Exit','Stop','Target','Net P&L','Strategy','Sleep','Stress','FOMO','Notes'];
                const rows=this.trades.map(t=>[
                    this.formatDate(t.entryDate),t.symbol,t.direction,t.quantity,t.entryPrice,t.exitPrice,t.stopLoss||'',t.targetPrice||'',t.netPL,t.strategy,t.sleepQuality||'',t.preStress||'',t.fomoLevel||'',t.notes.replace(/"/g,'""')
                ]);
                const csv=[header].concat(rows).map(r=>r.map(f=>typeof f==='string' && f.includes(',')?`"${f}"`:f).join(',')).join('\n');
                const blob=new Blob([csv],{type:'text/csv'});
                const url=URL.createObjectURL(blob);
                const a=document.createElement('a');
                a.href=url; a.download='trading_data_enhanced.csv'; a.click();
                URL.revokeObjectURL(url);
            }

            showTradeDetails(id) {
                const t = this.trades.find(tr=>tr.id === id);
                if(!t) return;
                const rrText = t.riskRewardRatio? t.riskRewardRatio.toFixed(2):'0.00';
                const body=document.getElementById('tradeModalBody');
                body.innerHTML=`<div class="trade-detail-grid">
                    <div class="trade-detail-item"><div class="trade-detail-label">Symbol</div><div class="trade-detail-value">${t.symbol}</div></div>
                    <div class="trade-detail-item"><div class="trade-detail-label">Direction</div><div class="trade-detail-value"><span class="trade-direction ${t.direction.toLowerCase()}">${t.direction}</span></div></div>
                    <div class="trade-detail-item"><div class="trade-detail-label">Quantity</div><div class="trade-detail-value">${t.quantity}</div></div>
                    <div class="trade-detail-item"><div class="trade-detail-label">Entry Price</div><div class="trade-detail-value">‚Çπ${t.entryPrice}</div></div>
                    <div class="trade-detail-item"><div class="trade-detail-label">Exit Price</div><div class="trade-detail-value">‚Çπ${t.exitPrice}</div></div>
                    <div class="trade-detail-item"><div class="trade-detail-label">Gross P&L</div><div class="trade-detail-value ${t.grossPL>=0?'positive':'negative'}">${this.formatCurrency(t.grossPL)}</div></div>
                    <div class="trade-detail-item"><div class="trade-detail-label">Net P&L</div><div class="trade-detail-value ${t.netPL>=0?'positive':'negative'}">${this.formatCurrency(t.netPL)}</div></div>
                    <div class="trade-detail-item"><div class="trade-detail-label">Risk:Reward</div><div class="trade-detail-value">1:${rrText}</div></div>
                    <div class="trade-detail-item"><div class="trade-detail-label">Strategy</div><div class="trade-detail-value">${t.strategy}</div></div>
                    <div class="trade-detail-item"><div class="trade-detail-label">Sleep Quality</div><div class="trade-detail-value">${t.sleepQuality||'N/A'}/10</div></div>
                    <div class="trade-detail-item"><div class="trade-detail-label">Pre-Stress</div><div class="trade-detail-value">${t.preStress||'N/A'}/10</div></div>
                    <div class="trade-detail-item"><div class="trade-detail-label">FOMO Level</div><div class="trade-detail-value">${t.fomoLevel||'N/A'}/10</div></div>
                </div>
                ${t.notes?`<div style="margin-top:16px;">Notes:<br>${t.notes}</div>`:''}
                ${t.lesson?`<div style="margin-top:16px;">Lesson Learned:<br>${t.lesson}</div>`:''}`;
                document.getElementById('tradeModal').classList.remove('hidden');
            }

            hideTradeModal(){ document.getElementById('tradeModal').classList.add('hidden'); }
        }

        window.app = new TradingJournalApp();
    </script>
</body>
</html>

